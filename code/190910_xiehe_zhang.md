# Xie He.
## Sample library preparation, sequencing, and data processing.

Following depletion of mitochondrial and cytoplasmic rRNA using Ribo-Zero Gold rRNA Removal (Illumina), mRNA libraries were sequenced on the Illumina HiSeq 2500 System with a per-sample target of 40–50 million 100 bp paired-end reads, according to the manufacturer’s protocol. 

Read data were subjected to quality control with FastQC and RNA-SeQC. 

The data in fastq format were mapped to GRCh37 using the STAR v2.4.0g1 aligner (https://github.com/alexdobin/STAR), and gene-level counts were estimated using HTSeq (https://pypi.python.org/pypi/HTSeq).

Prior to statistical analyses, raw gene read counts were converted to cpm using the edgeR 66 package within R (www.R-project.org). 

Genes with systematically low expression levels were removed, keeping only genes with c.p.m. > 0.1 in at least 10% of the samples analyzed (n = 17,337). 

Library sizes and normalization factors were estimated, and counts were then normalized using edgeR and voom in the limma R package 67, 68 , resulting in log 2 -cpms and weights for each gene. 

Multidimensional scaling analysis was used to identify outlier RNA-seq samples, resulting in removal of one sample (Supplementary Fig. 1) from the discovery cohort. 

In addition, we used variancePartition 69 , to assess the contribution of technical and biological factors to variation in gene expression across the samples. 

This revealed minimal inﬂuence of age and gender (Supplementary Fig. 6), and thus we did include these variables as covariates in the lme models next described.

## Identifying genes associated with acute peanut reactions. 

For the 19 subjects in the discovery cohort who reacted to peanut during their double-blind, placebocontrolled food challenges, null and test lme models were constructed for each gene, using the lme4 R package 10 . 

Each model included factor variables, “Time” (baseline, two hours, and four hours), “Challenge” (peanut or placebo), “Order” (which challenge came ﬁrst), and “Weights” (voom output) as ﬁxed effects, and per subject variation and collection date as random effects. 

Differentiating the two models was an interaction between the Time and Challenge variables (Time×Challenge) that was only present in the test model.

Null model: gene expression ~ Time + challenge + order + weights + individual + collection date + ε

Test model: gene expression ~ Time × challenge + order + weights + individual + collection date + ε

To identify genes with expression changes that occurred speciﬁcally during peanut but not placebo challenge, we used a likelihood ratio test (LRT) to test for a signiﬁcant additional contribution of the interaction between time and peanut vs. placebo exposure on gene expression in the test model when compared to the null model. 

The LRT was implemented in R using the lmtest package (www.R-project. org).

A similar approach was applied to RNA-seq data generated from the replication cohort. 

However, because this cohort only included data from peanut challenges, the LRT was used to test for an effect of “Time”.

## Coexpression network and gene ontology analyses. 
WGCNA was conducted using the WGCNA and coexpp R packages (https://bitbucket.org/multiscale/ coexpp). To construct a weighted gene coexpression network for food allergy, 139 RNA-seq samples from food allergic children were used, including the 107 samples from peanut allergic discovery cohort plus 32 samples from seven individuals with non-peanut food allergies who were recruited from the Mount Sinai Allergy/ Immunology practice during the same study period and analogously sampled during oral food challenges to their suspected food allergen (Supplementary Table 5). The rationale for including samples from food allergic children more broadly and not just those from peanut allergic subjects was that our goal was to build a coexpression network for food allergy upon which we could then project our peanut genes. Prior to WGCNA, the same expression level thresholds used previously for the lme model analysis were applied to the data set, resulting in 17,328 genes. Gene counts were again normalized using edgeR/voom, and the effects of collection date were removed. The resulting residuals were used for weighted gene coexpression network construction. An adjacency matrix was generated by applying a power function (beta = 6; Supplementary Fig. 7) to a pair-wise gene correlation (Pearson’s) matrix, initially estimated using per gene residual values. This was then transformed into a topological overlap matrix, from which module assignments were made using a dynamic tree cutting method.

We tested for enrichment of peanut genes in each module using the Fisher’s exact test. Enrichments of coexpression modules for GO “Biological Process” terms were assessed using GOrilla; 16 the full set of genes input into WGCNA was used as background.

## Probabilistic causal gene network construction. 

We constructed a directed probabilistic causal gene network by integrating peripheral blood gene expression data from 526 patients with IBD 20 and eQTL using RIMBAnet 19, 24, 25 , a software package we developed for constructing integrative molecular Bayesian networks. As these networks do not scale linearly with increasing nodes, we took the top 25% of varying genes to build this network 19, 25 . Continuous data was used for calculating partial priors, which are then used as priors in the network construction. Additional priors included genes that are cis eQTLs. For the eQTL priors, if a gene also has a strong eQTL associated with it in cis, such a gene can be considered as a parent node, given the genotype cannot be the effect of a gene expression change. The data was discretized into three states for each gene: high expression levels, low expression levels, and unexpressed. This is done by ﬁrst normalizing the values for each gene to ensure a normal distribution. Then, k-means clustering (k = 3) is used with the option of dropping groups should there not be enough members to ﬁll it to assign the values for each sample. In a case for which there are only two clusters they would be classiﬁed as high and low 19, 24, 25 .

To support our use of the IBD network, a peanut allergy-speciﬁc replication causal network was constructed using data from the peanut allergic discovery and replication cohorts. Speciﬁcally, the same genes that were used as input for the IBD network that were also expressed in the peanut allergic cohorts (n = 7055) were used. The data were discretized in the same fashion as the IBD data with analogous use of RIMBAnet 19, 24, 25 to construct a probabilistic causal network.

## Key driver analysis. 

Key driver analysis was conducted using the KDA package in R 17 . The package ﬁrst deﬁnes a background subnetwork by looking for a neighborhood K-steps away from each node in the target gene list in the network. Then, stemming from each node in this subnetwork, it assesses the enrichment in its kstep (k varies from 1 to K) downstream neighborhood for the target gene list. In this analysis, we used K = 7. KDA was run on both the IBD network as well as the peanut allergy-speciﬁc causal network.


